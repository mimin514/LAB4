#include "main.h"
#include "input_reading.h"
#include "led_display.h"

#define N0_OF_BUTTONS 4
#define DURATION_FOR_AUTO_INCREASING 100
#define BUTTON_IS_PRESSED GPIO_PIN_RESET
#define BUTTON_IS_RELEASED GPIO_PIN_SET

static GPIO_PinState buttonBuffer[N0_OF_BUTTONS];
static GPIO_PinState debounceButtonBuffer1[N0_OF_BUTTONS];
static GPIO_PinState debounceButtonBuffer2[N0_OF_BUTTONS];
static uint8_t flagForButtonPress1s[N0_OF_BUTTONS];
static uint16_t counterForButtonPress1s[N0_OF_BUTTONS];

void button_reading(void) {
    uint16_t button_pins[N0_OF_BUTTONS] = {GPIO_PIN_0, GPIO_PIN_1, GPIO_PIN_2, GPIO_PIN_8};

    for (char i = 0; i < N0_OF_BUTTONS; i++) {
        // Đọc nút nhấn và lưu vào buffer khử nảy
        GPIO_PinState currentState = HAL_GPIO_ReadPin(GPIOB, button_pins[i]);

        // Thực hiện khử nảy bằng cách so sánh hai buffer khử nảy liên tiếp
        debounceButtonBuffer2[i] = debounceButtonBuffer1[i];
        debounceButtonBuffer1[i] = currentState;

        if (debounceButtonBuffer1[i] == debounceButtonBuffer2[i]) {
            // Nếu hai lần đọc giống nhau thì xác nhận trạng thái cuối cùng
            buttonBuffer[i] = debounceButtonBuffer1[i];

            // Kiểm tra trạng thái nút nhấn đã được khử nảy
            if (buttonBuffer[i] == BUTTON_IS_PRESSED) {
                if (counterForButtonPress1s[i] < DURATION_FOR_AUTO_INCREASING) {
                    counterForButtonPress1s[i]++;
                } else {
                    // Nếu nút nhấn đã giữ hơn thời gian định trước
                    flagForButtonPress1s[i] = 1;
                }
            } else {
                // Reset bộ đếm nếu nút được nhả
                counterForButtonPress1s[i] = 0;
                flagForButtonPress1s[i] = 0;
            }
        }
    }
}

unsigned char is_button_pressed(uint8_t index){
    if (index >= N0_OF_BUTTONS) return 0;
    return (buttonBuffer[index] == BUTTON_IS_PRESSED);
}

unsigned char is_button_pressed_1s(unsigned char index){
    if (index >= N0_OF_BUTTONS) return 0xFF;
    return (flagForButtonPress1s[index] == 1);
}
