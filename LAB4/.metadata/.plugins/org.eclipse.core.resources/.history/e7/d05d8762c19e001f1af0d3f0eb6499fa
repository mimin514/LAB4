#define N0_OF_BUTTONS 4               // Số nút nhấn
#define BUTTON_IS_PRESSED GPIO_PIN_RESET // Trạng thái khi nút được nhấn
#define DEBOUNCE_DELAY 50             // Thời gian debounce (ms)
#define DURATION_FOR_AUTO_INCREASING 1000 // Thời gian giữ nút để kích hoạt hành động tự động (1s)

uint16_t button_pins[N0_OF_BUTTONS] = {GPIO_PIN_0, GPIO_PIN_1, GPIO_PIN_2, GPIO_PIN_8};  // Mảng chứa các chân GPIO của nút nhấn
GPIO_PinState debounceButtonBuffer1[N0_OF_BUTTONS];  // Mảng bộ đệm lần 1
GPIO_PinState debounceButtonBuffer2[N0_OF_BUTTONS];  // Mảng bộ đệm lần 2
GPIO_PinState buttonBuffer[N0_OF_BUTTONS];           // Mảng lưu trạng thái của các nút nhấn
uint32_t counterForButtonPress1s[N0_OF_BUTTONS];     // Bộ đếm thời gian giữ nút (1s)
uint8_t flagForButtonPress1s[N0_OF_BUTTONS];         // Cờ để đánh dấu khi nút được nhấn lâu hơn 1s

uint32_t last_debounce_time = 0;   // Thời gian của lần kiểm tra nút nhấn trước
uint32_t current_time = 0;         // Thời gian hiện tại (ms)

void Button_Reading(void) {
    current_time = HAL_GetTick();  // Lấy thời gian hiện tại (tính bằng ms)

    for (char i = 0; i < N0_OF_BUTTONS; i++) {
        // Đọc trạng thái nút nhấn và lưu vào buffer khử nảy
        GPIO_PinState currentState = HAL_GPIO_ReadPin(GPIOB, button_pins[i]);

        // Thực hiện khử nảy bằng cách so sánh hai buffer khử nảy liên tiếp
        debounceButtonBuffer2[i] = debounceButtonBuffer1[i];
        debounceButtonBuffer1[i] = currentState;

        // Kiểm tra nếu hai lần đọc giống nhau (khử nảy)
        if (debounceButtonBuffer1[i] == debounceButtonBuffer2[i]) {
            buttonBuffer[i] = debounceButtonBuffer1[i];  // Xác nhận trạng thái cuối cùng của nút

            // Kiểm tra trạng thái nút nhấn
            if (buttonBuffer[i] == BUTTON_IS_PRESSED) {
                if (counterForButtonPress1s[i] < DURATION_FOR_AUTO_INCREASING) {
                    counterForButtonPress1s[i]++;  // Tăng bộ đếm nếu nút được nhấn
                } else {
                    // Nếu nút đã nhấn lâu hơn thời gian định sẵn (1s)
                    flagForButtonPress1s[i] = 1;  // Đánh dấu cờ
                    HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_8);  // Đảo trạng thái LED (bật/tắt)
                }
            } else {
                // Nút đã được nhả
                counterForButtonPress1s[i] = 0;  // Reset bộ đếm
                flagForButtonPress1s[i] = 0;    // Reset cờ
            }
        }
    }

    // Kiểm tra thời gian debounce để giảm thiểu sai sót
    if ((current_time - last_debounce_time) > DEBOUNCE_DELAY) {
        last_debounce_time = current_time;  // Cập nhật thời gian lần kiểm tra trước
    }
}
